generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id           String   @id @default(uuid())
  name         String
  ownerUserId  String?  @map("owner_user_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  members        Member[]
  planTypes      PlanType[]
  trainers       Trainer[]
  dailySnapshots DailyActivitySnapshot[]
  expenses       Expense[]
  investments    Investment[]

  @@map("organizations")
}

model Member {
  id            String    @id @default(uuid())
  orgId         String    @map("org_id")
  clerkUserId   String?   @map("clerk_user_id")
  firstName     String    @map("first_name")
  lastName      String    @map("last_name")
  phone         String
  email         String
  dateOfBirth   DateTime  @map("date_of_birth")
  gender        String
  joinDate      DateTime  @map("join_date")
  notes         String?
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  organization  Organization @relation(fields: [orgId], references: [id])
  memberships   Membership[]
  trainings     Training[]
  payments      Payment[]

  @@index([orgId])
  @@index([phone])
  @@index([clerkUserId])
  @@map("members")
}

model PlanType {
  id          String    @id @default(uuid())
  orgId       String    @map("org_id")
  name        String
  description String?
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")

  category    PlanCategory @default(membership)

  organization Organization   @relation(fields: [orgId], references: [id])
  variants     PlanVariant[]

  @@index([orgId])
  @@index([isActive])
  @@index([category])
  @@map("plan_types")
}

model PlanVariant {
  id            String   @id @default(uuid())
  planTypeId    String   @map("plan_type_id")
  durationDays  Int      @map("duration_days")
  durationLabel String   @map("duration_label")
  price         Float
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")

  planType    PlanType     @relation(fields: [planTypeId], references: [id], onDelete: Cascade)
  memberships Membership[]
  trainings   Training[]

  @@index([planTypeId])
  @@index([isActive])
  @@map("plan_variants")
}

enum PlanCategory {
  membership
  training
}

enum MembershipStatus {
  active
  expired
  cancelled
  frozen
}

enum TrainingStatus {
  active
  expired
  cancelled
  frozen
}

enum PaymentMethod {
  cash
  card
  upi
  bank_transfer
  other
}

enum PaymentStatus {
  paid
  pending
  failed
  refunded
}

model Membership {
  id              String           @id @default(uuid())
  orgId           String           @map("org_id")
  memberId        String           @map("member_id")
  planVariantId   String           @map("plan_variant_id")
  startDate       DateTime         @map("start_date")
  endDate         DateTime         @map("end_date")
  status          MembershipStatus @default(active)
  priceAtPurchase Float            @map("price_at_purchase")
  discountAmount  Float            @default(0) @map("discount_amount")
  finalPrice      Float            @map("final_price")
  autoRenew       Boolean          @default(false) @map("auto_renew")
  notes           String?
  createdAt       DateTime         @default(now()) @map("created_at")
  updatedAt       DateTime         @updatedAt @map("updated_at")

  member      Member      @relation(fields: [memberId], references: [id])
  planVariant PlanVariant @relation(fields: [planVariantId], references: [id])
  payments    Payment[]

  @@index([memberId])
  @@index([status])
  @@index([endDate])
  @@map("memberships")
}

model Training {
  id              String         @id @default(uuid())
  orgId           String         @map("org_id")
  memberId        String         @map("member_id")
  planVariantId   String         @map("plan_variant_id")
  trainerId       String         @map("trainer_id")
  startDate       DateTime       @map("start_date")
  endDate         DateTime       @map("end_date")
  status          TrainingStatus @default(active)
  priceAtPurchase Float          @map("price_at_purchase")
  discountAmount  Float          @default(0) @map("discount_amount")
  finalPrice      Float          @map("final_price")
  autoRenew       Boolean        @default(false) @map("auto_renew")
  notes           String?
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  member      Member      @relation(fields: [memberId], references: [id])
  planVariant PlanVariant @relation(fields: [planVariantId], references: [id])
  trainer     Trainer     @relation(fields: [trainerId], references: [id])
  payments    Payment[]

  @@index([memberId])
  @@index([status])
  @@index([endDate])
  @@index([trainerId])
  @@map("trainings")
}

model Trainer {
  id        String     @id @default(uuid())
  orgId     String     @map("org_id")
  name      String
  isActive  Boolean    @default(true) @map("is_active")
  createdAt DateTime   @default(now()) @map("created_at")
  updatedAt DateTime   @updatedAt @map("updated_at")

  organization Organization @relation(fields: [orgId], references: [id])
  trainings    Training[]

  @@index([orgId])
  @@index([isActive])
  @@map("trainers")
}

model Payment {
  id           String        @id @default(uuid())
  orgId        String        @map("org_id")
  memberId     String        @map("member_id")
  membershipId String?       @map("membership_id")
  trainingId   String?       @map("training_id")
  amount       Float
  method       PaymentMethod
  status       PaymentStatus @default(pending)
  reference    String?
  notes        String?
  paidAt       DateTime?     @map("paid_at")
  createdAt    DateTime      @default(now()) @map("created_at")

  member     Member      @relation(fields: [memberId], references: [id])
  membership Membership? @relation(fields: [membershipId], references: [id])
  training   Training?   @relation(fields: [trainingId], references: [id])

  @@index([memberId])
  @@index([membershipId])
  @@index([trainingId])
  @@map("payments")
}

// ─── Cron: Daily activity snapshots ───────────────────────────────────────────

model DailyActivitySnapshot {
  id              String   @id @default(uuid())
  orgId           String   @map("org_id")
  snapshotDate    DateTime @db.Date @map("snapshot_date")
  totalMembers    Int      @map("total_members")
  activeMembers   Int      @map("active_members")
  inactiveMembers Int      @map("inactive_members")
  newlyExpired    Int      @map("newly_expired")
  createdAt       DateTime @default(now()) @map("created_at")

  org             Organization @relation(fields: [orgId], references: [id])

  @@unique([orgId, snapshotDate])
  @@index([orgId])
  @@map("daily_activity_snapshots")
}

// ─── Financials ───────────────────────────────────────────────────────────────

enum ExpenseCategory {
  rent
  utilities
  staff
  equipment
  marketing
  maintenance
  other
}

model Expense {
  id          String          @id @default(uuid())
  orgId       String          @map("org_id")
  amount      Float
  category    ExpenseCategory @default(other)
  description String?
  date        DateTime        @db.Date
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  org         Organization @relation(fields: [orgId], references: [id])

  @@index([orgId])
  @@index([date])
  @@map("expenses")
}

model Investment {
  id        String   @id @default(uuid())
  orgId     String   @map("org_id")
  name      String
  amount    Float
  date      DateTime @db.Date
  notes     String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  org       Organization @relation(fields: [orgId], references: [id])

  @@index([orgId])
  @@map("investments")
}
